<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Membership Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* General Body and Container Enhancements */
        body {
            font-family: 'Inter', sans-serif; /* A modern, clean font - consider linking from Google Fonts */
            background-image: linear-gradient(to right bottom, #f0f4f8, #e6e9ed); /* Subtle gradient background */
            color: #333; /* Darker default text for readability */
        }

        /* Enhancements for the main app container */
        #app {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        /* Login Page Specific Styling */
        #login-container .bg-white {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        #login-container .bg-white:hover {
            transform: translateY(-5px); /* Lift card slightly on hover */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* More pronounced shadow */
        }

        #login-container img {
            max-width: 150px; /* Adjust logo size */
            height: auto;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); /* Subtle shadow for logo */
        }

        /* Dashboard Header Styling */
        header {
            background-color: #ffffff; /* White background for header */
            border-radius: 0.75rem; /* Rounded corners for header */
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* Soft shadow */
            margin-bottom: 2rem; /* Space below header */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header img {
            height: 50px; /* Adjust height of dashboard logo */
            margin-right: 1rem;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.1));
        }

        header h1 {
            color: #1a202c; /* Darker heading color */
        }

        /* Form and Card Enhancements */
        .bg-white {
            border-radius: 0.75rem; /* Consistent rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Slightly stronger shadow for cards */
        }

        input[type="text"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="password"],
        select {
            border: 1px solid #cbd5e0; /* Lighter border color */
            padding: 0.75rem 1rem; /* More padding */
            border-radius: 0.5rem; /* Softer rounded corners for inputs */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        select {
             padding-right: 2.5rem; /* Make space for the dropdown arrow */
             appearance: none;
             background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23a0aec0"%3e%3cpath fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"%3e%3c/path%3e%3c/svg%3e');
             background-repeat: no-repeat;
             background-position: right 0.75rem center;
             background-size: 1.5em 1.5em;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="password"]:focus,
        select:focus {
            border-color: #3b82f6; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Soft blue glow on focus */
            outline: none; /* Remove default outline */
        }

        /* Button Styling Enhancements */
        button {
            font-weight: 600; /* Slightly bolder text for buttons */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }

        button:hover {
            transform: translateY(-1px); /* Slight lift on hover */
        }

        button:active {
            transform: translateY(0); /* Press effect */
        }

        /* Specific button colors (as per your existing Tailwind) */
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-blue-500:hover { background-color: #2563eb; }

        .bg-green-500 { background-color: #22c55e; }
        .bg-green-500:hover { background-color: #16a34a; }

        .bg-red-500 { background-color: #ef4444; }
        .bg-red-500:hover { background-color: #dc2626; }

        /* Table Enhancements */
        table {
            border-collapse: separate; /* Allows border-radius on cells (though not directly applied here) */
            border-spacing: 0;
        }

        th, td {
            padding: 1rem 1.5rem; /* More padding for table cells */
            border-bottom: 1px solid #e2e8f0; /* Lighter border for rows */
        }

        thead th {
            background-color: #f8fafc; /* Lighter header background */
            color: #64748b; /* Slightly darker grey for header text */
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody tr:hover {
            background-color: #f0f8ff; /* Light blue on row hover */
            transition: background-color 0.2s ease-in-out;
        }

        /* Status Badges */
        .px-2.inline-flex {
            padding-top: 0.3em;
            padding-bottom: 0.3em;
            border-radius: 9999px; /* Fully rounded pills */
            font-size: 0.75rem; /* Slightly smaller font for badges */
            font-weight: 700; /* Bolder text for badges */
        }

        /* Expired row styling - keep existing */
        .expired {
            background-color: #fee2e2; /* Tailwind red-100 */
            border-left: 4px solid #ef4444; /* Tailwind red-500 */
        }

        /* Live Status Cards */
        #status-cards > div {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        #status-cards > div:hover {
            transform: translateY(-3px); /* Lift on hover */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Subtle shadow on hover */
        }

        #status-cards .font-bold.text-2xl {
            font-size: 2.5rem; /* Slightly larger numbers */
        }

        /* Scrollbar Styling (Webkit - for Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* Color of the scrollbar track */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0aec0; /* Color of the scrollbar handle (gray-400) */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* Color on hover (gray-600) */
        }

        /* Fade-in Animation (existing, just kept here for completeness) */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4">
        <div id="login-container" class="flex justify-center items-center h-screen">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <div class="text-center mb-8">
                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/f4fad6c0-0a0e-4fd4-b48c-2dff22b4c333.png" alt="Gym logo showing dumbbell and fitness text in bold letters" class="mx-auto mb-4" />
                    <h1 class="text-2xl font-bold text-gray-800">Gym Admin Login</h1>
                </div>
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Username</label>
                        <input type="text" id="username" class="w-full px-3 py-2 border rounded shadow appearance-none" required placeholder="hisham">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border rounded shadow appearance-none" required placeholder="12345">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150">
                        Login
                    </button>
                </form>
            </div>
        </div>

        <div id="dashboard-container" class="hidden py-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/c321c8b1-2be3-419d-8052-90dde091f596.png" alt="Gym management system logo with fitness icons" class="mb-2" />
                    <h1 class="text-3xl font-bold text-gray-800">Gym Membership System</h1>
                </div>
                <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition duration-150">
                    Logout
                </button>
            </header>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8 fade-in">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Add New Member</h2>
                <form id="member-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="member-name">Full Name</label>
                            <input type="text" id="member-name" class="w-full px-3 py-2 border rounded shadow appearance-none" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="mobile-number">Mobile Number</label>
                            <input type="tel" id="mobile-number" class="w-full px-3 py-2 border rounded shadow appearance-none" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Membership Fee</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <span class="text-gray-500">₹</span>
                                </div>
                                <select id="fee-amount" class="w-full pl-8 px-3 py-2 border rounded shadow appearance-none" required>
                                    <option value="">Select Fee</option>
                                    <option value="500">500 (30 Days)</option>
                                    <option value="1000">1000 (60 Days)</option>
                                    <option value="1200">1200 (90 Days)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Membership Start Date</label>
                            <input type="date" id="start-date" class="w-full px-3 py-2 border rounded shadow appearance-none" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150">
                        Add Member
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800">Members List</h2>
                        <span class="text-xs text-green-600" id="last-updated"></span>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="Search by name or number..." class="w-full md:w-auto px-3 py-2 border rounded shadow appearance-none">
                        <div class="text-sm text-gray-500" id="current-date"></div>
                        <button id="export-pdf" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm w-full md:w-auto">
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mobile</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fee (₹)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th> 
                            </tr>
                        </thead>
                        <tbody id="members-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mt-6 text-center fade-in">
                <h3 class="text-lg font-semibold mb-4">Live Members Status</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="status-cards">
                    </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
            <p class="mb-6">Are you sure you want to delete <span id="member-name-to-delete" class="font-semibold"></span>?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - replaced with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyBe_k7RxoQa2g_Vyw3niG_M74pIPw8Mz0U",
            authDomain: "gym-fees-5dbcf.firebaseapp.com",
            databaseURL: "https://gym-fees-5dbcf-default-rtdb.firebaseio.com", 
            projectId: "gym-fees-5dbcf",
            storageBucket: "gym-fees-5dbcf.firebasestorage.app",
            messagingSenderId: "423386853721",
            appId: "1:423386853721:web:fafd195e95e6b1cb091c48"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // DOM elements
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const memberForm = document.getElementById('member-form');
        const membersList = document.getElementById('members-list');
        const currentDateDisplay = document.getElementById('current-date');
        const statusCards = document.getElementById('status-cards'); 
        const searchInput = document.getElementById('search-input'); // New: Search input
        const feeAmountSelect = document.getElementById('fee-amount'); // New: Fee select dropdown
        
        // Confirmation Modal elements
        const confirmModal = document.getElementById('confirm-modal');
        const memberNameToDeleteSpan = document.getElementById('member-name-to-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let memberKeyToDelete = null; // To store the key of the member being deleted
        let allMembersData = {}; // New: Cache all members data for search functionality

        // Define membership durations based on fees
        const membershipDurations = {
            "500": 30,  // 500 = 30 days
            "1000": 60, // 1000 = 60 days
            "1200": 90  // 1200 = 90 days
        };

        // Show today's date
        const today = new Date();
        currentDateDisplay.textContent = `Today: ${today.toLocaleDateString()}`;

        // --- Login Functionality ---
        // Clear username and password fields on page load
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === '7860') {
                loginContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                loadMembers();
                setDefaultDate();
                updateTimestamp(); 
            } else {
                errorMessage.textContent = 'Who are you? Unauthorized access attempted.';
                errorMessage.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => {
            loginContainer.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            loginForm.reset();
            errorMessage.classList.add('hidden');
            // Clear the username and password fields again on logout
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // Default to today's date in the form
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
        }

        // --- Add New Member ---
        memberForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('member-name').value;
            const mobile = document.getElementById('mobile-number').value;
            const fee = feeAmountSelect.value; // Get fee from select dropdown
            const startDate = document.getElementById('start-date').value;
            
            const startDateObj = new Date(startDate);
            const durationDays = membershipDurations[fee]; // Get duration based on selected fee

            if (!durationDays) { // Validate if a fee with a defined duration was selected
                alert("Please select a valid membership fee.");
                return;
            }

            const endDateObj = new Date(startDateObj);
            endDateObj.setDate(startDateObj.getDate() + durationDays); // Set end date based on duration
            
            const member = {
                name: name,
                mobile: mobile,
                fee: fee,
                startDate: startDate,
                endDate: endDateObj.toISOString().split('T')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('members').push(member)
                .then(() => {
                    memberForm.reset();
                    setDefaultDate();
                    feeAmountSelect.value = ""; // Reset fee selection
                })
                .catch(error => {
                    console.error("Error adding member: ", error);
                });
        });

        // --- Live Status Counters ---
        function updateStatusCounts(membersData) {
            let activeCount = 0;
            let expiredCount = 0;
            let totalIncome = 0; 
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            for (const key in membersData) {
                const member = membersData[key];
                const endDate = new Date(member.endDate);
                endDate.setHours(0, 0, 0, 0); 
                
                if (today <= endDate) {
                    activeCount++;
                    totalIncome += parseFloat(member.fee);
                } else {
                    expiredCount++;
                }
            }
            
            statusCards.innerHTML = `
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-green-800 font-bold text-2xl">${activeCount}</div>
                    <div class="text-green-600">Active Members</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <div class="text-red-800 font-bold text-2xl">${expiredCount}</div>
                    <div class="text-red-600">Expired Members</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-blue-800 font-bold text-2xl">${activeCount + expiredCount}</div>
                    <div class="text-blue-600">Total Members</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="text-yellow-800 font-bold text-2xl">₹${totalIncome.toLocaleString()}</div>
                    <div class="text-yellow-600">Total Active Income</div>
                </div>
            `;
        }

        // --- Load Members from Firebase and Filter for Search ---
        function loadMembers() {
            database.ref('members').on('value', (snapshot) => {
                allMembersData = snapshot.val(); // Cache all members data
                displayMembers(allMembersData); // Display all members initially
                updateStatusCounts(allMembersData); // Update status counts with all data
                updateTimestamp();
            });
        }

        // New: Function to display members (can be filtered)
        function displayMembers(membersToDisplay) {
            membersList.innerHTML = ''; 
            if (membersToDisplay) {
                const sortedMembers = Object.keys(membersToDisplay).map(key => ({
                    key,
                    ...membersToDisplay[key]
                })).sort((a, b) => b.timestamp - a.timestamp); 

                sortedMembers.forEach((member) => {
                    addMemberToTable(member, member.key);
                });
            } else {
                // No members or no matching members
            }
        }

        // New: Search functionality
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredMembers = {};

            if (allMembersData) {
                for (const key in allMembersData) {
                    const member = allMembersData[key];
                    // Check if name or mobile number contains the search term
                    if (member.name.toLowerCase().includes(searchTerm) || 
                        member.mobile.toLowerCase().includes(searchTerm)) {
                        filteredMembers[key] = member;
                    }
                }
            }
            displayMembers(filteredMembers); // Display filtered members
        });

        // Function to generate WhatsApp URL with a reminder message
        function getWhatsAppReminderUrl(member) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(member.endDate);
            endDate.setHours(0, 0, 0, 0);
            const isExpired = today > endDate;

            let message = `Hello ${member.name},\n\n`;

            if (isExpired) {
                message += `Your gym membership expired on ${formatDate(member.endDate)}.\n`;
                message += `Please renew your membership of ₹${member.fee} to continue enjoying our services.`;
            } else {
                message += `This is a friendly reminder for your gym membership renewal.\n`;
                message += `Your current membership is valid until ${formatDate(member.endDate)}.\n`;
                message += `Please prepare for the renewal payment of ₹${member.fee}.`;
            }
            message += `\n\nThank you,\n${encodeURIComponent('Gym Management')}`; 

            const mobileNumberClean = member.mobile.replace(/\D/g, ''); 
            const countryCode = '91'; // Assuming India, change if needed
            const fullMobileNumber = countryCode + mobileNumberClean;

            return `https://wa.me/${fullMobileNumber}?text=${encodeURIComponent(message)}`;
        }

        // --- Add Member to the Table (with Edit & Delete) ---
        function addMemberToTable(member, key) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const endDate = new Date(member.endDate);
            endDate.setHours(0, 0, 0, 0); 
            const isExpired = today > endDate;
            
            const row = document.createElement('tr');
            row.dataset.key = key; // Store Firebase key on the row
            if (isExpired) {
                row.classList.add('expired');
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap member-name" data-field="name">${member.name}</td>
                <td class="px-6 py-4 whitespace-nowrap member-mobile" data-field="mobile">${member.mobile}</td>
                <td class="px-6 py-4 whitespace-nowrap member-fee" data-field="fee">
                    <span class="fee-display">₹${member.fee}</span>
                    <select class="border rounded px-2 py-1 w-20 fee-edit-select hidden">
                        <option value="500" ${member.fee == 500 ? 'selected' : ''}>500</option>
                        <option value="1000" ${member.fee == 1000 ? 'selected' : ''}>1000</option>
                        <option value="1200" ${member.fee == 1200 ? 'selected' : ''}>1200</option>
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap member-start-date" data-field="startDate">${formatDate(member.startDate)}</td>
                <td class="px-6 py-4 whitespace-nowrap member-end-date" data-field="endDate">${formatDate(member.endDate)}</td>
                <td class="px-6 py-4 whitespace-nowrap member-status">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${isExpired ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${isExpired ? 'Expired' : 'Active'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center space-x-2">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm edit-btn">
                            Edit
                        </button>
                        <button class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm save-btn hidden">
                            Save
                        </button>
                        <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm delete-btn" data-name="${member.name}">
                            Delete
                        </button>
                        <a href="${getWhatsAppReminderUrl(member)}" target="_blank" 
                           class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm whatsapp-btn">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" class="inline-block h-4 w-4 mr-1">
                            Remind
                        </a>
                    </div>
                </td>
            `;
            
            membersList.appendChild(row);
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            try {
                const date = new Date(dateString);
                // Check for "Invalid Date"
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                return date.toLocaleDateString(undefined, options);
            } catch (e) {
                console.error("Error formatting date:", e);
                return 'Invalid Date';
            }
        }

        // --- Edit & Save Functionality for table cells ---
        membersList.addEventListener('click', (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return; // Not inside a table row

            const key = row.dataset.key;

            if (target.classList.contains('edit-btn')) {
                // Hide edit, show save
                target.classList.add('hidden');
                row.querySelector('.save-btn').classList.remove('hidden');
                row.querySelector('.delete-btn').classList.add('hidden'); // Hide delete during edit
                row.querySelector('.whatsapp-btn').classList.add('hidden'); // Hide whatsapp during edit

                // Make Name and Mobile editable
                const nameCell = row.querySelector('.member-name');
                const mobileCell = row.querySelector('.member-mobile');
                
                nameCell.innerHTML = `<input type="text" value="${nameCell.textContent}" class="w-full border rounded px-2 py-1 edit-input" data-field="name">`;
                mobileCell.innerHTML = `<input type="tel" value="${mobileCell.textContent}" class="w-full border rounded px-2 py-1 edit-input" data-field="mobile">`;
                
                // Make Fee editable (toggle input visibility)
                row.querySelector('.fee-display').classList.add('hidden');
                row.querySelector('.fee-edit-select').classList.remove('hidden'); // Show fee select

                // Make Start Date editable (convert to input type="date")
                const startDateCell = row.querySelector('.member-start-date');
                const currentStartDateText = startDateCell.textContent; // e.g., "Jul 23, 2025"
                let currentStartDateIso = '';

                // Try to parse the displayed date back into YYYY-MM-DD
                try {
                    const parsedDate = new Date(currentStartDateText);
                    if (!isNaN(parsedDate.getTime())) {
                        currentStartDateIso = parsedDate.toISOString().split('T')[0];
                    }
                } catch (error) {
                    console.error("Error parsing start date for edit:", error);
                }
                startDateCell.innerHTML = `<input type="date" value="${currentStartDateIso}" class="w-full border rounded px-2 py-1 edit-input" data-field="startDate">`;

            } else if (target.classList.contains('save-btn')) {
                const updatedMember = {};
                let needsDateRecalculation = false;

                // Get updated Name and Mobile
                const nameInput = row.querySelector('.member-name input');
                const mobileInput = row.querySelector('.member-mobile input');
                if (nameInput) updatedMember.name = nameInput.value;
                if (mobileInput) updatedMember.mobile = mobileInput.value;

                // Get updated Fee from select
                const feeEditSelect = row.querySelector('.fee-edit-select');
                if (feeEditSelect) updatedMember.fee = feeEditSelect.value;

                // Get updated Start Date
                const startDateInput = row.querySelector('.member-start-date input');
                if (startDateInput) {
                    updatedMember.startDate = startDateInput.value;
                    needsDateRecalculation = true; // Recalculate end date if start date changes
                }

                // Fetch current member data to preserve untouched fields
                database.ref('members/' + key).once('value', (snapshot) => {
                    const currentMemberData = snapshot.val();
                    let finalUpdate = { ...currentMemberData, ...updatedMember };

                    // If start date changed or a new fee was selected, recalculate end date
                    if ((needsDateRecalculation && updatedMember.startDate) || (updatedMember.fee && updatedMember.fee !== currentMemberData.fee)) {
                        const newStartDateObj = new Date(updatedMember.startDate || currentMemberData.startDate); // Use new or existing start date
                        const newDurationDays = membershipDurations[updatedMember.fee || currentMemberData.fee]; // Use new or existing fee to get duration
                        
                        if (newDurationDays) { // Only recalculate if a valid duration is found
                            const newEndDateObj = new Date(newStartDateObj);
                            newEndDateObj.setDate(newStartDateObj.getDate() + newDurationDays);
                            finalUpdate.endDate = newEndDateObj.toISOString().split('T')[0];
                        } else {
                            console.warn("Could not determine duration for fee:", updatedMember.fee || currentMemberData.fee); // Warn if duration is not found
                        }
                    } else if (!updatedMember.startDate && needsDateRecalculation) {
                         // Handle case where start date is cleared, perhaps set end date to N/A or default
                         finalUpdate.endDate = null; // Or some default like today + 30 days
                    }

                    // Update Firebase
                    database.ref('members/' + key).set(finalUpdate)
                        .then(() => {
                            console.log('Member updated successfully!');
                            // The Firebase listener will automatically re-render the row
                            // No need to manually update the DOM here.
                        })
                        .catch(error => {
                            console.error("Error updating member: ", error);
                        });
                });

            } else if (target.classList.contains('delete-btn')) {
                const memberName = target.dataset.name;
                memberKeyToDelete = key; // Store the key globally
                memberNameToDeleteSpan.textContent = memberName; // Display name in modal
                confirmModal.classList.remove('hidden'); // Show modal
            }
        });

        // --- Confirmation Modal Button Listeners ---
        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            memberKeyToDelete = null; // Reset
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (memberKeyToDelete) {
                database.ref('members/' + memberKeyToDelete).remove()
                    .then(() => {
                        console.log('Member deleted successfully!');
                        confirmModal.classList.add('hidden');
                        memberKeyToDelete = null; // Reset
                    })
                    .catch(error => {
                        console.error("Error deleting member: ", error);
                        confirmModal.classList.add('hidden');
                        memberKeyToDelete = null; // Reset even on error
                    });
            }
        });


        // --- PDF Export Functionality Fix ---
        document.getElementById('export-pdf').addEventListener('click', () => {
            const doc = new jspdf.jsPDF();
            
            doc.setFontSize(18);
            doc.setTextColor(40);
            doc.text('Gym Member Database', 15, 20);
            
            doc.setFontSize(10);
            doc.text(`Exported: ${new Date().toLocaleString()}`, 15, 30);
            
            const tableData = [];
            const tableHeaders = ['Name', 'Mobile', 'Fee (₹)', 'Start Date', 'End Date', 'Status']; // Exclude 'Actions' for PDF
            
            // Iterate directly over Firebase data to ensure consistency and avoid DOM parsing issues
            // We need to fetch data again or use the cached data from loadMembers
            database.ref('members').once('value', (snapshot) => {
                const membersData = snapshot.val();
                if (membersData) {
                    const sortedMembers = Object.keys(membersData).map(key => ({
                        key,
                        ...membersData[key]
                    })).sort((a, b) => b.timestamp - a.timestamp); 

                    sortedMembers.forEach(member => {
                        const todayForStatus = new Date();
                        todayForStatus.setHours(0, 0, 0, 0);
                        const endDateForStatus = new Date(member.endDate);
                        endDateForStatus.setHours(0, 0, 0, 0);
                        const status = (todayForStatus > endDateForStatus) ? 'Expired' : 'Active';

                        tableData.push([
                            member.name,
                            member.mobile,
                            `₹${member.fee}`, // Format fee for PDF
                            formatDate(member.startDate),
                            formatDate(member.endDate),
                            status
                        ]);
                    });
                }
                
                doc.autoTable({
                    head: [tableHeaders],
                    body: tableData,
                    startY: 40,
                    styles: {
                        fontSize: 9,
                        cellPadding: 1,
                        overflow: 'linebreak'
                    },
                    didParseCell: function(data) {
                        if (data.column.index === 5 && data.cell.raw) { // Status column
                            const statusText = data.cell.raw; // raw is the actual value from tableData
                            if (statusText === 'Expired') {
                                data.cell.styles.textColor = [239, 68, 68]; 
                            } else if (statusText === 'Active') {
                                data.cell.styles.textColor = [34, 197, 94]; 
                            }
                        }
                    }
                });
                
                doc.save(`gym-members-${new Date().toISOString().slice(0,10)}.pdf`);
            });
        });

        // Real-time update timestamp
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-updated').textContent = `Last updated: ${timeString}`;
        }

        // --- Initialize and Event Listeners ---
        setDefaultDate();

        setInterval(() => {
            if (!dashboardContainer.classList.contains('hidden')) { 
                updateTimestamp();
            }
        }, 1000 * 60);
    </script>
</body>
</html>
